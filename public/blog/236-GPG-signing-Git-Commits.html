<!DOCTYPE html><!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>
	<meta charset="utf-8" />
    <title>GPG-signing Git Commits :: phly, boy, phly</title>
	<!--[if lt IE 9]>
		<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <link href="/css/SkeletonCss/base.css" media="screen" rel="stylesheet" type="text/css" >
<link href="/css/SkeletonCss/skeleton.css" media="screen" rel="stylesheet" type="text/css" >
<link href="/css/SkeletonCss/layout.css" media="screen" rel="stylesheet" type="text/css" >
<link href="/css/Application/site.css" media="screen" rel="stylesheet" type="text/css" >
<link href="/images/Application/favicon.ico" rel="shortcut icon" type="image/vnd.microsoft.icon" >
<link href="/css/PhlyBlog/phly-blog.css" media="screen" rel="stylesheet" type="text/css" >
<link href="/blog-atom.xml" rel="alternate" type="application/atom+xml" title="phly, boy, phly Atom Feed" >
<link href="/blog-rss.xml" rel="alternate" type="application/rss+xml" title="phly, boy, phly RSS Feed" >
    
<script type="text/javascript">
//<!--
    var djConfig = {"isDebug":true,"parseOnLoad":true,"baseUrl":"\/js\/dojo\/","modulePaths":{"PhlyBlog":"\/js\/PhlyBlog","Application":"\/js\/Application"}};
//-->
</script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/dojo/1.6/dojo/dojo.xd.js"></script>

<script type="text/javascript">
//<!--
dojo.require("PhlyBlog.blog");
    dojo.require("Application.scroll");
//-->

</script>
    
    <script src="https://www.google.com/jsapi?ABQIAAAAGybdRRvLZwVUcF0dE3oVdBTO-MlgA7VGJpGqyqTOeDXlNzyZQxTGq17s-iAB0m0vwqLQ_A2dHhTg2Q"></script>
<script type="text/javascript">
    google.load('search', '1', {style: google.loader.themes.ESPRESSO});
    google.setOnLoadCallback(function(){
        new google.search.CustomSearchControl().draw('search');
    }, true);
</script>

    <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-27037983-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

</head>
<body>
<div class="container">
    <header class="sixteen columns">
    <a href="/"><img src="/images/Application/logo.gif" height="37" width="37" alt="Celtic Knot" /></a>
        <span class="main_title">phly, boy, phly: matthew weier o'phinney</span>
    </header>

    <div class="sixteen columns" id="menu">
        <nav><ul>
            <li><a href="/">Home</a></li>
            <li><a href="/blog.html">Blog</a></li>
                        <li><a href="/resume">R&eacute;sum&eacute;</a></li>
            <li><a href="/contact">Contact</a></li>
        </ul></nav>
    </div>

    <div class="sixteen columns content">
        <div class="row">
<article class="eleven columns alpha blog">
<h2>GPG-signing Git Commits</h2>
<p>
    We're working on migrating <a href="http://framework.zend.com/">Zend
        Framework</a> to <a href="http://git-scm.org/">Git</a>. One issue we're
    trying to deal with is enforcing that commits come from <acronym
        title="Contributor License Agreement">CLA</acronym> signees.
</p>

<p>
    One possibility presented to us was the possibility of utilizing
    <acronym title="GNU Privacy Guard">GPG</acronym> signing of commit messages.
    Unfortunately, I was able to find little to no information on the 'net about
    how this might be done, so I started to experiment with some solutions.
</p>

<p>
    The approach I chose utilizes <a
        href="http://www.kernel.org/pub/software/scm/git/docs/githooks.html">git
        hooks</a>, specifically the <code>commit-msg</code> hook client-side,
    and the <code>pre-receive</code> hook server-side.
</p><h2>Client-side commit-msg hook</h2>

<p>
    The <code>commit-msg</code> hook receives a single argument, the path to the
    temporary file containing the commit message. This allows you to inspect it
    or modify it prior to completing the commit. Like all git hooks, a non-zero
    exit status will abort the commit.
</p>

<p>
    My <code>commit-msg</code> hook looks like the following:
</p>

<div class="example"><pre><code lang="bash">
#!/bin/sh
echo -n \&quot;GPG Signing message... \&quot;;
PASSPHRASE=$(git config --get hooks.gpg.passphrase)
if [ \&quot;\&quot; = \&quot;$PASSPHRASE\&quot; ];then
    echo \&quot;no passphrase found! Set it with git config --add hooks.gpg.passphrase &lt;passphrase&gt;\&quot;
    exit 1
fi
gpg --clearsign --yes --passphrase $PASSPHRASE -o $1.asc $1
mv $1.asc $1
echo \&quot;[DONE]\&quot;
</code></pre></div>

<p>
    This hook requires that you first add your GPG key's passphrase to your
    local git configuration, which can be done as follows:
</p>

<div class="example"><pre><code lang="bash">
% git config --add hooks.gpg.passphrase \&quot;mySecret\&quot;
</code></pre></div>

<p>
    Once this hook is in place, all commit messages are then clear-signed,
    leading to commit logs that look like the following:
</p>

<div class="example"><pre><code lang="bash">
commit f921f0defb18f8a5218d5c3346693dbb4179920e
Author: Matthew Weier O'Phinney &lt;somebody@example.com&gt;
Date:   Tue Mar 23 17:18:35 2010 -0400

    -----BEGIN PGP SIGNED MESSAGE-----
    Hash: SHA1
    
    how now, brown cow
    -----BEGIN PGP SIGNATURE-----
    Version: GnuPG v1.4.9 (GNU/Linux)
    
    iEYEARECAAYFAkupMCsACgkQtUV5aSPtKdqERQCeN5taRATpB4/XJZiP9Vs5FVNY
    PcoAn0OZbIIcn7nC01yxp9tY7HbxVVFu
    =C/Ju
    -----END PGP SIGNATURE-----
</code></pre></div>

<h2>Server-side pre-receive hook</h2>

<p>
    The <code>pre-receive</code> hook is a lot less straight-forward. This hook
    receives input via <code>STDIN</code>. Each line consists of three items,
    separated by a single space:
</p>

<pre>
[previous commit's sha1] [new commit's sha1] [refspec]
</pre>

<p>
    Typically, only the new sha1 is of much use to us. Internally, git is
    actually keeping track of the new commit, even though it has not technically
    been accepted into the repository. This allows us to use tools such as
    <code>git show</code> to get information on the commit and act on that
    information.
</p>

<p>
    What I needed to do was inspect the commit message for a GPG-signed message;
    if none was found, reject the commit outright, but if one was present,
    validate it against my keyring, and abort if the signed message is invalid.
</p>

<p>
    I originally started by using <code>git show --pretty="format:%b"
        [sha1]</code> However, I discovered that git does something... odd... to
    commit messages. The first 50 characters or so are considered the commit's
    "subject" -- and any newlines found in the subject are silently stripped.
    This meant that I was getting, for my purposes, a truncated message that
    would never validate (as the GPG signature header was getting stripped);
    even including the subject in the format did not work, since the newlines
    within it were missing. The only way I found to get the full commit message
    was to use <code>git show --pretty=raw [sha1]</code>. This, however, gives
    me also the commit headers as well as the diff -- which means I have to
    parse the response.
</p>

<p>
    What follows is a PHP implementation I did that does exactly that: grabs the
    full message and redirects it to a temporary file, parses that file for the
    commit message, and then acts on it. 
</p>

<div class="example"><pre><code lang="php">
#!/usr/bin/php
&lt;?php
echo \&quot;Checking for GPG signature... \&quot;;
$fh     = fopen('php://stdin', 'r');
$tmpdir = sys_get_temp_dir();
while (!feof($fh)) {
    $line = fgets($fh);
    list($old, $new, $ref) = explode(' ', $line);

    // Create a tmp file with the commit log
    $logTmp   = tempnam($tmpdir, 'LOG_');
    $body     = shell_exec('git show --pretty=raw ' . $new . ' &gt; ' . $logTmp);

    $msgTmp   = tempnam($tmpdir, 'MESSAGE_');

    // Scan the commit log for a commit message
    $log = fopen($logTmp, 'r');
    $msg = fopen($msgTmp, 'a');
    $signatureDetected = false;
    while (!feof($log)) {
        $line = fgets($log);
        if (preg_match('/^(commit(ter)?|tree|parent|author)\s/', $line)) {
            // Skip the commit log headers
            continue;
        }
        if (preg_match('/^diff\s/', $line)) {
            // Stop scanning when we reach the diff
            break;
        }
        if (preg_match('/^\s+-+BEGIN [A-Z]+ SIGNED MESSAGE/', $line)) {
            // We have a signed message, so start appending it 
            // to a separate tmp file
            $signatureDetected = true;
            $line = preg_replace('/^\s+/', '', $line);
            fwrite($msg, $line);
            continue;
        }
        if ($signatureDetected) {
            // If we have detected a signed message, continue appending lines to
            // it. Commit message lines are indented, so strip indentation.
            $line = preg_replace('/^\s+/', '', $line);
            if ('' === $line) {
                $line = \&quot;\n\&quot;;
            }
            fwrite($msg, $line);
        }
    }
    fclose($log);
    fclose($msg);

    if (!signatureDetected) {
        // No signed message detected; report and abort
        unlink($logTmp);
        unlink($msgTmp);
        echo \&quot;no GPG signature detected; commit aborted\n\&quot;;
        exit(1);
    }

    $verification = shell_exec('gpg --verify ' . $msgTmp . ' 2&gt;&amp;1');
    if (!preg_match('/Good signature/s', $verification)) {
        // Failed to verify signed message; report and abort
        unlink($logTmp);
        unlink($msgTmp);
        echo \&quot;invalid GPG signature; commit aborted\n\&quot;;
        exit(1);
    }

    unlink($logTmp);
    unlink($msgTmp);
}
echo \&quot;verified!\n\&quot;;
exit(0);
</code></pre></div>

<p>
    There are likely more elegant ways to accomplish this, including solutions
    in other languages. However, it works quite well.
</p>

<h2>Conclusions</h2>

<p>
    Git hooks are quite powerful, and delving into them has given me confidence
    that I can create some nice automation for the ZF git repository when we are
    ready to open it to the public.
</p>

<p>
    That said, I don't know if we'll actually use commit signing such as this,
    as it has a few drawbacks:
</p>

<ul>
    <li>The commit signing is not really cross-platform. This can likely be
    remedied, but it would require that people on different operating systems
    and using different tools (such as EGit, TortoiseGit, etc) develop and
    provide signing mechanisms for the client-side.</li>

    <li>It introduces complexity for those developing patches. If developers
    begin without having the <code>commit-msg</code> hook in place, they then
    have to create a new branch and a squashed commit afterwards in order to
    ensure the final patches can go into the canonical repository.</li>

    <li>The two reasons above kind of defeat the purpose of moving to a
    Distributed VCS in the first place -- which is to simplify development and
    make it more democratic.</li>
</ul>

<p>
    Regardless of whether or not we decide to use this technique, when
    researching the issue, I saw plenty of posts from people wanting to
    implement commit signing, but not sure how to accomplish it. Perhaps this
    post will serve as a starting point for many.
</p><div class="social-media">
<a href="https://twitter.com/share" class="twitter-share-button" data-via="weierophinney">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</div>

<div class="social-media">
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<div class="fb-like" data-send="true" data-width="450" data-show-faces="true"></div>
</div>

<div class="social-media">
<div class="g-plusone" data-size="medium" data-annotation="inline"></div>
</div>

<!-- Place this render call where appropriate -->
<script type="text/javascript">
dojo.ready(function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
});
</script>

<div class="social-media">
<a href="http://www.reddit.com/submit" onclick="window.location = 'http://www.reddit.com/submit?url=' + encodeURIComponent(window.location); return false"> <img src="http://www.reddit.com/static/spreddit1.gif" alt="submit to reddit" border="0" /> </a>
</div>

    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_developer = 1;
        var disqus_shortname = 'phlyboyphly';
        var disqus_identifier = '236-GPG-signing-Git-Commits';
        var disqus_url = 'http://mwop.net/blog/236-GPG-signing-Git-Commits.html';
        var disqus_title = 'GPG-signing Git Commits';

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a></article>

<aside class="four columns offset-by-one omega sidebar blog">
    <div class="metadata">
        <ul>
            <li>Posted on <b>2010-03-24 12:26:43</b>.</li>
            <li>Last updated on <b>2010-03-25 06:57:03</b>.</li>
        </ul>
    </div>

    <div class="metadata">
        <h4>Tags for this entry</h4>
        <p class="tags"><a href="/blog/tag/linux.html">linux</a><br />
<a href="/blog/tag/php.html">php</a></p>
    </div>

        <div class="metadata">
        <h4>Blogroll</h4>
        <ul>
            <li><a href="http://sebastian-bergmann.de/">Sebastian Bergmann</a></li>
            <li><a href="http://blog.calevans.com/">Cal Evans</a></li>
            <li><a href="http://prematureoptimization.org/blog/">Shahar Evron</a></li>
            <li><a href="http://paul-m-jones.com/blog/">Paul M. Jones</a></li>
            <li><a href="http://karwin.blogspot.com/">Bill Karwin</a></li>
            <li><a href="http://mikenaberezny.com/">Mike Naberezny</a></li>
            <li><a href="http://fabien.potencier.org/">Fabien Potencier</a></li>
            <li><a href="http://benramsey.com/">Ben Ramsey</a></li>
            <li><a href="http://derickrethans.nl/">Derick Rethans</a></li>
            <li><a href="http://ralphschindler.com/">Ralph Schindler</a></li>
            <li><a href="http://www.zimuel.it/blog/">Enrico Zimuel</a></li>
        </ul>
    </div>

</aside>

    </div>

    <footer class="sixteen columns footer">
        <div class="column one-third alpha about">
            <h4>About</h4>
            <p>
    I'm a husband, father of two, slave to an ancient Basset Hound and 
    plaything of a Basset puppy, and web architect by day.
</p>

<ul class="resume">
    <li><a href="/resume">Resume</a></li>
    <li><a href="http://twitter.com/weierophinney">Twitter</a></li>
    <li><a href="http://www.linkedin.com/in/mweierophinney">LinkedIn</a></li>
    <li><a href="http://www.ohloh.net/accounts/weierophinney">OhLoh</a></li>
    <li><a href="http://resume.github.com/?weierophinney">GitHub</a></li>
</ul>

        </div>

        <div class="column one-third projects">
            <h4>Projects</h4>
            <ul class="projects">
    <li><a href="http://framework.zend.com/">Zend Framework (Project Lead)</a></li>
    <li><a href="http://github.com/weierophinney/phly_mustache">Phly_Mustache</a></li>
    <li><a href="http://www.the-pastry-box-project.net/baker/matthew-weier-ophinney/">The Pastry Box Project</a> (as a Baker)</li>
</ul>

        </div>

        <div class="column one-third omega tags">
        <div id="search" style="width:100%;">Loading...</div>
<h4>Tag Cloud</h4>
<div class="cloud">
<ul class="Zend\Tag\Cloud"><li><a href="/blog/tag/php.html" style="font-size: 20px;">php</a></li> <li><a href="/blog/tag/zend+framework.html" style="font-size: 14px;">zend framework</a></li> <li><a href="/blog/tag/zf2.html" style="font-size: 11px;">zf2</a></li> <li><a href="/blog/tag/vim.html" style="font-size: 11px;">vim</a></li> <li><a href="/blog/tag/family.html" style="font-size: 11px;">family</a></li> <li><a href="/blog/tag/programming.html" style="font-size: 12px;">programming</a></li> <li><a href="/blog/tag/personal.html" style="font-size: 13px;">personal</a></li> <li><a href="/blog/tag/phpconcom.html" style="font-size: 10px;">phpconcom</a></li> <li><a href="/blog/tag/mvc.html" style="font-size: 11px;">mvc</a></li> <li><a href="/blog/tag/oop.html" style="font-size: 11px;">oop</a></li> <li><a href="/blog/tag/testing.html" style="font-size: 10px;">testing</a></li> <li><a href="/blog/tag/rest.html" style="font-size: 11px;">rest</a></li> <li><a href="/blog/tag/linux.html" style="font-size: 12px;">linux</a></li> <li><a href="/blog/tag/zendcon08.html" style="font-size: 11px;">zendcon08</a></li> <li><a href="/blog/tag/file_fortune.html" style="font-size: 10px;">file_fortune</a></li> <li><a href="/blog/tag/pear.html" style="font-size: 11px;">pear</a></li> <li><a href="/blog/tag/zendcon.html" style="font-size: 11px;">zendcon</a></li> <li><a href="/blog/tag/perl.html" style="font-size: 12px;">perl</a></li> <li><a href="/blog/tag/fastcgi.html" style="font-size: 10px;">fastcgi</a></li> <li><a href="/blog/tag/ubuntu.html" style="font-size: 11px;">ubuntu</a></li> <li><a href="/blog/tag/tekx.html" style="font-size: 10px;">tekx</a></li> <li><a href="/blog/tag/zendcon10.html" style="font-size: 10px;">zendcon10</a></li> <li><a href="/blog/tag/dojo.html" style="font-size: 11px;">dojo</a></li> <li><a href="/blog/tag/symfony.html" style="font-size: 11px;">symfony</a></li> <li><a href="/blog/tag/zeta+components.html" style="font-size: 10px;">zeta components</a></li> <li><a href="/blog/tag/tek09.html" style="font-size: 10px;">tek09</a></li> <li><a href="/blog/tag/spl.html" style="font-size: 11px;">spl</a></li> <li><a href="/blog/tag/subversion.html" style="font-size: 11px;">subversion</a></li> <li><a href="/blog/tag/zend+framewor.html" style="font-size: 10px;">zend framewor</a></li> <li><a href="/blog/tag/rails.html" style="font-size: 10px;">rails</a></li> <li><a href="/blog/tag/conferences.html" style="font-size: 11px;">conferences</a></li> <li><a href="/blog/tag/dpc08.html" style="font-size: 11px;">dpc08</a></li> <li><a href="/blog/tag/phpworks08.html" style="font-size: 11px;">phpworks08</a></li> <li><a href="/blog/tag/webinar.html" style="font-size: 11px;">webinar</a></li> <li><a href="/blog/tag/zencon08.html" style="font-size: 10px;">zencon08</a></li> <li><a href="/blog/tag/advocacy.html" style="font-size: 10px;">advocacy</a></li> <li><a href="/blog/tag/politics.html" style="font-size: 10px;">politics</a></li> <li><a href="/blog/tag/internet.html" style="font-size: 10px;">internet</a></li> <li><a href="/blog/tag/cw09.html" style="font-size: 11px;">cw09</a></li> <li><a href="/blog/tag/zend+server.html" style="font-size: 10px;">zend server</a></li> <li><a href="/blog/tag/dpc09.html" style="font-size: 10px;">dpc09</a></li> <li><a href="/blog/tag/sflive2010.html" style="font-size: 10px;">sflive2010</a></li> <li><a href="/blog/tag/security.html" style="font-size: 10px;">security</a></li> <li><a href="/blog/tag/wifi.html" style="font-size: 10px;">wifi</a></li> <li><a href="/blog/tag/aikido.html" style="font-size: 10px;">aikido</a></li> <li><a href="/blog/tag/books.html" style="font-size: 10px;">books</a></li> <li><a href="/blog/tag/dpc10.html" style="font-size: 10px;">dpc10</a></li> <li><a href="/blog/tag/zendcon09.html" style="font-size: 11px;">zendcon09</a></li> <li><a href="/blog/tag/git.html" style="font-size: 10px;">git</a></li> <li><a href="/blog/tag/phpwomen.html" style="font-size: 10px;">phpwomen</a></li> <li><a href="/blog/tag/virtualbox.html" style="font-size: 10px;">virtualbox</a></li></ul></div>
        </div>
    </footer>
</div>
</body>
</html>
